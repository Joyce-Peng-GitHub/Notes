考虑预处理出每个块内的前缀 / 后缀 $\max$，再预处理出块间 $\max$，则对于左右端点不在同一块内的询问，显然可以在 $O(1)$ 复杂度内完成；而左右端点在同一块内的情况下复杂度为 $O(B)$。注意到询问随机，所以两端点在同一块内的概率为 $\dfrac{1}{B}$，也就是说仅有期望 $O(\dfrac{q}{B})$ 个询问两端点在同一块内，于是复杂度为 $O(q + B \times \dfrac{q}{B}) = O(q)$。

为了预处理复杂度较优，可以将块长设为 $\sqrt{n}$。

***

假设数据不随机，$n, q$ 同阶，考虑如何让尽可能多的询问落在同一块内。设块长为 $B$，询问长度为 $len \le B$，则两端点落在同一块内的概率为 $(B - len + 1) \times \dfrac{1}{B} = \dfrac{B - len + 1}{B}$，则期望最优的 $len = \dfrac{B + 1}{2}$，此时询问的期望复杂度为 $O(\dfrac{Bq}{4})$。预处理的复杂度为 $O(\dfrac{n}{B} \log \dfrac{n}{B})$ ，为了平衡询问和预处理复杂度，大致可以得到 $\dfrac{B^2}{4} + \log B = \log n$，不妨取 $B = \sqrt{\log n}$，那么最终的复杂度约为 $O(n \sqrt{\log n})$。

当然出题人也会得到这样的一个最优块长估计，所以仍然需要在此基础上加扰动来防止被卡。