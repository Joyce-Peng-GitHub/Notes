显然每个数只会改变 $O(\log M)$ 次。所以只需每块记录一个 tag 表示这一块是不是都变成了 1，如果不是则暴力修改整块，显然每块最多也被修改 $O(\log M)$ 次，于是复杂度为 $O(q(\dfrac{n}{B} \log M + B))$，由均值不等式可得最优块长为 $B = \sqrt{n \log M}$。

***

另一个复杂度更优的做法：用并查集不断跳过已经全部为 1 的段，用树状数组维护区间和，复杂度为 $O(n \log n \log M)$。